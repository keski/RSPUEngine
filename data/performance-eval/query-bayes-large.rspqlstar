# Query demonstrating the Bayesian Network uncertainty type over a single event stream when the network
# is very large.
# The query reports the most likely observation for one of the top of the root (BG-10), given a random observation
# at the bottom of the tree (BG-20). For exact inference this limits execution time to ~10 events/s. With Henrion
# sampling this can be managed up to

BASE <http://base/>
PREFIX : <http://www.example.org/ontology#>
PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
PREFIX sosa: <http://www.w3.org/ns/sosa/>
PREFIX rspu: <http://w3id.org/rsp/rspu#>
PREFIX rspu-fn: <http://w3id.org/rsp/rspu/fn#>
PREFIX bn-ns: <http://w3id.org/rsp/rspu/bn#>

REGISTER STREAM <bayes> COMPUTED EVERY PT1S AS

SELECT (COUNT(?event) AS ?count) #?event ?hr ?state ?degree1 ?degree2 ?unc
FROM NAMED WINDOW <w> ON <http://ecareathome/stream/heartrate> [RANGE PT1S STEP PT1S]
WHERE {
   WINDOW <w> {
      GRAPH ?g {
          ?event a :HeartRate .
          ?event sosa:hasSimpleResult ?hr .
          << ?event a ?node >> rspu:hasState ?state .
          << ?event a :HighHeartRateEvent >> rspu:degree ?degree1 .
          << ?event a :VeryHighHeartRateEvent >> rspu:degree ?degree2 .

          # Bayes
          BIND(URI(CONCAT("http://www.example.org/ontology#x", STR(xsd:integer(ROUND(RAND()*9)) * 2 + 2), "mmol_l")) AS ?obs)
          BIND(rspu-fn:map(<http://example.org/bn/medical-large>, :bg_10, :bg_20    , ?obs) AS ?unc)
      }
   }
}